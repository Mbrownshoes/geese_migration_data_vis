<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  background: "#fcfcfa";
}
/*.bird {
  fill: #fff;
}*/

.stroke {
  fill: none;
  stroke: #000;
  stroke-width: 3px;
}

.fill {
  fill: rgba(70,130,180,.5);
}

.graticule {
  fill: none;
  stroke: #777;
  stroke-width: .5px;
  stroke-opacity: .5;
}

.land {
  fill: #222;
}

.boundary {
  fill: none;
  stroke: #fff;
  stroke-width: .5px;
}

</style>

<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<!-- <script src="http://libs.cartocdn.com/cartodb.js/v2/cartodb.js"></script> -->
<script>

var width = 960,
	height = 960;

var projection = d3.geo.orthographic()
					.scale(650)
					.translate([width / 2, height / 2])
					.clipAngle(90)
					.precision(.1)
					.rotate([50.7, -76.8])

var path = d3.geo.path()
			.projection(projection)


var graticule = d3.geo.graticule();

var svg = d3.select("body")
			.append("svg")
			.attr("width", width)
			.attr("height", height);

	svg.append("defs")
		.append("path")
		.datum({type: "Sphere"})
		.attr("id", "sphere")
		.attr("d", path);

	svg.append("use")
		.attr("class", "stroke")
		.attr("xlink:href", "#sphere");

	svg.append("use")
		.attr("class", "fill")
		.attr("xlink:href", "#sphere")

	svg.append("path")
		.datum(graticule)
		.attr("class", "graticule")
		.attr("d", path);

	d3.json("world.json", function(error, world) {
			svg.insert("path", ".graticule")
				.datum(topojson.feature(world, world.objects.land))
				.attr("class", "land")
				.attr("d", path);

			svg.insert("path", ".graticule")
				.datum(topojson.mesh(world, world.objects.countries, function(a, b) {
					return a!==b;
					}))
				.attr("class", "boundary")
				.attr("d", path);

	});

d3.select(self.frameElement).style("height", height + "px");

var allgeese;
var feat;
var loaded_geese=[];

d3.json("build/geese.json", function(error, geese) {
	if (error) return console.error(error);
	

	allgeese = topojson.feature(geese, geese.objects.geese)
	feat = allgeese.features;

	// console.log(d3.keys(feat[0]))

	var geeseName = d3.nest()
					.key(function(feat) {
					return feat.properties.name;
					})
					.entries(feat);
	
	

	for (var j=0; j< geeseName.length; j++) {
		eachBird = geeseName[j];
		loaded_geese.push(eachBird);
		makeCircles();
	};
	


// first bird 556
// second bird 567


	// animate each point for each bird
	svg.selectAll("circle")
		   .transition()
		   .delay(function(d, i) {
		   	console.log(d)
		   	try {
		   		if (i == 0)
		   			startTime = new Date(eachBird.values[i].properties.datetime);
		   		dateTime = new Date(eachBird.values[i].properties.datetime);
		   		console.log(i)
		   		z=eachBird;
			   return ((dateTime/60000)-(startTime/60000))/4;
			}catch(e){
				// console.log(e)
			}
		   })
		   .duration(500)
		   .style("fill", "blue")
			.style("fill-opacity", 0.5)
			.style("stroke", "red")
			.style("stroke-opacity", 0.5)
			.attr("r", 20)
			.ease(Math.sqrt)
			.style("fill-opacity", 1e-6)
			.remove()
});



function makeCircles() {
	for (var i=0; i< eachBird.values.length; i++) {
		var c = eachBird.values[i];
			
			svg.append("circle")
			.attr("cx", projection(c.geometry.coordinates)[0])
			.attr("cy", projection(c.geometry.coordinates)[1])
			
	};
};

    </script>
  </body>
</html>












